<template>
	<div class="assistant-form">
		<span class="assistant-bubble">
			<CreationIcon :size="16" class="icon" />
			<span>{{ t('assistant', 'Nextcloud Assistant') }}</span>
		</span>
		<TaskTypeSelect
			:value.sync="mySelectedTaskTypeId"
			class="task-custom-select"
			:inline="3"
			:options="taskTypes" />
		<h2 v-if="selectedTaskType"
			class="task-name">
			{{ selectedTaskType.name }}
		</h2>
		<span v-if="selectedTaskType"
			class="task-description">
			{{ selectedTaskType.description }}
		</span>
		<AssistantFormInputs
			:inputs.sync="myInputs"
			:selected-task-type-id="mySelectedTaskTypeId" />
		<div v-if="myOutput !== null"
			class="output">
			<label
				for="assistant-output"
				class="input-label">
				{{ t('assistant', 'Result') }}
			</label>
			<div v-if="mySelectedTaskTypeId === 'OCP\\TextToImage\\Task'"
				ref="output">
				<a :href="formattedOutput" class="external">{{ formattedOutput }}</a>
				<Text2ImageDisplay
					:image-gen-id="myOutput" />
			</div>
			<NcRichContenteditable v-else
				id="assistant-output"
				ref="output"
				:value.sync="myOutput"
				class="editable-output"
				:multiline="true"
				:disabled="loading"
				:placeholder="t('assistant', 'Result')"
				:link-autocomplete="false" />
			<NcNoteCard v-if="outputEqualsInput"
				class="warning-note"
				type="warning">
				{{ t('assistant', 'The task ran successfully but the result is identical to the input.') }}
			</NcNoteCard>
			<NcNoteCard v-else-if="hasInitialOutput"
				class="warning-note"
				type="warning">
				{{ t('assistant', 'This output was generated by AI. Make sure to double-check and adjust.') }}
			</NcNoteCard>
			<NcNoteCard v-else
				class="warning-note"
				type="warning">
				{{ t('assistant', 'The task ran successfully but the generated text is empty.') }}
			</NcNoteCard>
		</div>
		<div class="footer">
			<NcButton
				v-if="showSubmit"
				:type="submitButtonType"
				class="submit-button"
				:disabled="!canSubmit"
				:title="t('assistant', 'Run a task')"
				@click="onSyncSubmit">
				{{ syncSubmitButtonLabel }}
				<template #icon>
					<NcLoadingIcon v-if="loading" />
					<CreationIcon v-else />
				</template>
			</NcButton>
			<NcButton
				v-if="hasOutput"
				type="primary"
				class="copy-button"
				:title="t('assistant', 'Copy output')"
				@click="onCopy">
				{{ t('assistant', 'Copy') }}
				<template #icon>
					<ClipboardCheckOutlineIcon v-if="copied" />
					<ContentCopyIcon v-else />
				</template>
			</NcButton>
			<div v-if="hasOutput"
				class="action-buttons">
				<NcButton
					v-for="(b, i) in actionButtons"
					:key="i"
					:type="b.type ?? 'secondary'"
					:title="b.title"
					@click="onActionButtonClick(b)">
					{{ b.label }}
					<template v-if="b.iconSvg" #icon>
						<NcIconSvgWrapper :svg="b.iconSvg" />
					</template>
				</NcButton>
			</div>
		</div>
		<div class="history">
			<NcButton class="advanced-button"
				type="tertiary"
				:aria-label="t('assistant', 'Show/hide task history')"
				@click="showHistory = !showHistory">
				<template #icon>
					<ChevronDownIcon v-if="showHistory" />
					<ChevronRightIcon v-else />
				</template>
				{{ t('assistant', 'Task history') }}
			</NcButton>
			<TaskList v-if="showHistory"
				class="history--list"
				:task-type="mySelectedTaskTypeId" />
		</div>
	</div>
</template>

<script>
import ContentCopyIcon from 'vue-material-design-icons/ContentCopy.vue'
import ClipboardCheckOutlineIcon from 'vue-material-design-icons/ClipboardCheckOutline.vue'
import CreationIcon from 'vue-material-design-icons/Creation.vue'
import ChevronRightIcon from 'vue-material-design-icons/ChevronRight.vue'
import ChevronDownIcon from 'vue-material-design-icons/ChevronDown.vue'

import NcLoadingIcon from '@nextcloud/vue/dist/Components/NcLoadingIcon.js'
import NcButton from '@nextcloud/vue/dist/Components/NcButton.js'
import NcRichContenteditable from '@nextcloud/vue/dist/Components/NcRichContenteditable.js'
import NcNoteCard from '@nextcloud/vue/dist/Components/NcNoteCard.js'
import NcIconSvgWrapper from '@nextcloud/vue/dist/Components/NcIconSvgWrapper.js'

import TaskTypeSelect from './TaskTypeSelect.vue'
import AssistantFormInputs from './AssistantFormInputs.vue'
import Text2ImageDisplay from './Text2Image/Text2ImageDisplay.vue'
import TaskList from './TaskList.vue'

import axios from '@nextcloud/axios'
import { generateOcsUrl, generateUrl } from '@nextcloud/router'
import { showError } from '@nextcloud/dialogs'
import VueClipboard from 'vue-clipboard2'
import Vue from 'vue'

Vue.use(VueClipboard)

const FREE_PROMPT_TASK_TYPE_ID = 'OCP\\TextProcessing\\FreePromptTaskType'

export default {
	name: 'AssistantTextProcessingForm',
	components: {
		TaskList,
		Text2ImageDisplay,
		TaskTypeSelect,
		NcButton,
		NcRichContenteditable,
		NcLoadingIcon,
		NcIconSvgWrapper,
		CreationIcon,
		ContentCopyIcon,
		ClipboardCheckOutlineIcon,
		ChevronDownIcon,
		ChevronRightIcon,
		NcNoteCard,
		AssistantFormInputs,
	},
	props: {
		loading: {
			type: Boolean,
			default: false,
		},
		inputs: {
			type: Object,
			default: () => {},
		},
		output: {
			type: [String, null],
			default: null,
		},
		selectedTaskTypeId: {
			type: [String, null],
			default: null,
		},
		actionButtons: {
			type: Array,
			default: () => [],
		},
	},
	emits: [
		'sync-submit',
		'submit',
		'action-button-clicked',
	],
	data() {
		return {
			myInputs: this.inputs,
			myOutput: this.output,
			taskTypes: [],
			mySelectedTaskTypeId: this.selectedTaskTypeId || FREE_PROMPT_TASK_TYPE_ID,
			copied: false,
			showHistory: false,
		}
	},
	computed: {
		selectedTaskType() {
			if (this.mySelectedTaskTypeId === null) {
				return null
			}
			return this.taskTypes.find(tt => tt.id === this.mySelectedTaskTypeId)
		},
		submitButtonType() {
			return this.hasOutput ? 'secondary' : 'primary'
		},
		showSubmit() {
			return this.selectedTaskType
		},
		canSubmit() {
			// Check that none of the properties of myInputs are empty
			return Object.values(this.myInputs).every(v => {
				return (typeof v === 'string' && !!v?.trim())
					|| (typeof v === 'boolean')
					|| (typeof v === 'number')
					|| (typeof v === 'object' && !!v)
			})
				&& this.selectedTaskType
		},
		submitButtonLabel() {
			return this.hasOutput
				? t('assistant', 'Try again')
				: this.selectedTaskType.id === FREE_PROMPT_TASK_TYPE_ID
					? t('assistant', 'Send request')
					: this.selectedTaskType.name
		},
		syncSubmitButtonLabel() {
			return this.output !== null
				? t('assistant', 'Try again')
				: this.selectedTaskType.id === FREE_PROMPT_TASK_TYPE_ID
					? t('assistant', 'Send request')
					: this.selectedTaskType.name
		},
		hasInitialOutput() {
			return !!this.output?.trim()
		},
		hasOutput() {
			return !!this.myOutput?.trim()
		},
		outputEqualsInput() {
			return this.hasInitialOutput && this.output?.trim() === this.inputs.prompt?.trim()
		},
		formattedOutput() {
			if (this.mySelectedTaskTypeId === 'OCP\\TextToImage\\Task') {
				return window.location.protocol + '//' + window.location.host + generateUrl('/apps/assistant/i/{imageGenId}', { imageGenId: this.myOutput })
			}
			return this.myOutput.trim()
		},
	},
	watch: {
		output(newVal) {
			this.myOutput = newVal
		},
		inputs(newVal) {
			this.myInputs = newVal
		},
	},
	mounted() {
		this.getTaskTypes()
	},
	methods: {
		getTaskTypes() {
			axios.get(generateOcsUrl('textprocessing/tasktypes', 2))
				.then((response) => {
					this.taskTypes = response.data.ocs.data.types

					// Check if FREE_PROMPT_TASK_TYPE_ID is available
					if (this.taskTypes.find(tt => tt.id === FREE_PROMPT_TASK_TYPE_ID)) {
						// change free prompt task type name
						this.taskTypes = this.taskTypes.map(type => {
							if (type.id === FREE_PROMPT_TASK_TYPE_ID) {
								type.name = t('assistant', 'Generate text')
								type.description = t('assistant', 'Send a request to the Assistant, for example: write a first draft of a presentation, give me suggestions for a presentation, write a draft reply to my colleague.')
							}
							return type
						})
						// inject a copywriter task type
						this.taskTypes.push({
							id: 'copywriter',
							name: t('assistant', 'Context write'),
							description: t('assistant', 'Writes text in a given style based on the provided source material.'),
						})
						// inject a STT task type
						this.taskTypes.push({
							id: 'speech-to-text',
							name: t('assistant', 'Transcribe'),
							description: t('assistant', 'Transcribe audio to text'),
						})
						// inject a T2I task type
						this.taskTypes.push({
							id: 'OCP\\TextToImage\\Task',
							name: t('assistant', 'Generate image'),
							description: t('assistant', 'Generate an image from a text'),
						})
					}
				})
				.catch((error) => {
					console.error(error)
				})
		},
		onSubmit() {
			this.$emit('submit', { inputs: this.myInputs, selectedTaskTypeId: this.mySelectedTaskTypeId })
		},
		onSyncSubmit() {
			this.$emit('sync-submit', { inputs: this.myInputs, selectedTaskTypeId: this.mySelectedTaskTypeId })
		},
		async onCopy() {
			try {
				const container = this.$refs.output.$el ?? this.$refs.output
				await this.$copyText(this.formattedOutput, container)
				this.copied = true
				setTimeout(() => {
					this.copied = false
				}, 5000)
			} catch (error) {
				console.error(error)
				showError(t('assistant', 'Result could not be copied to clipboard'))
			}
		},
		onActionButtonClick(button) {
			this.$emit('action-button-clicked', { button, output: this.formattedOutput })
		},
	},
}
</script>

<style lang="scss" scoped>
.assistant-form {
	width: 100%;
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	gap: 12px;
	overflow-y: auto;
	overflow-x: hidden;

	.output {
		width: 96%;
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		margin-right: 16px;
		margin-left: 16px;
		.editable-output {
			width: 100%;
			:deep(.rich-contenteditable__input) {
				max-height: 300px !important;
			}
		}

		.warning-note {
			align-self: normal;
		}

		.input-label {
			align-self: start;
			font-weight: bold;
		}
	}

	.assistant-bubble {
		align-self: start;
		display: flex;
		gap: 8px;
		background-color: var(--color-primary-element-light);
		border-radius: var(--border-radius-rounded);
		padding: 2px 8px;
		.icon {
			color: var(--color-primary);
		}
	}

	.task-custom-select {
		width: 100%;
	}

	.task-action-select {
		width: 100%;
	}

	.task-name {
		margin-bottom: 0px;
	}

	.task-name,
	.task-description {
		align-self: start;
	}

	.footer {
		width: 100%;
		display: flex;
		flex-wrap: wrap;
		justify-content: end;
		gap: 4px;
		.action-buttons {
			display: flex;
			flex-wrap: wrap;
			justify-content: end;
			gap: 4px;
		}
	}

	.history {
		width: 100%;
		display: flex;
		flex-direction: column;
		align-items: end;

		&--list {
			width: 100%;
		}
	}

	.success-icon {
		color: var(--color-success);
	}
}
</style>
